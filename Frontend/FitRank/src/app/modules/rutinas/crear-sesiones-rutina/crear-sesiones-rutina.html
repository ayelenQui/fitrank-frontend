<div class="rutina-layout" [class.expandido]="mostrarSesiones">

  <!-- üü£ HERO -->
  <section class="fit-hero">
    <div class="fit-hero__grid">
      <div class="fit-hero__media">
        <img src="assets/img/home/plan.png" alt="Atleta entrenando" />
      </div>

      <div class="fit-hero__content">
        <h1 class="fit-hero__title  ">Planificaci√≥n de Entrenamiento</h1>
        <p class="fit-hero__subtitle">
          Entren√° m√°s inteligente, segu√≠ tus progresos y alcanz√° tus metas.
        </p>

        <form class="plan-card" [formGroup]="form" (ngSubmit)="onGenerarSesiones()">
          <h2 class=" plan-card__title">Planific√° cu√°ntos d√≠as de entreno</h2>
          <div class="plan-card__row">
            <input type="number"
                   class="plan-card__input btn-secondary"
                   formControlName="cantidadDias"
                   placeholder="1..."
                   min="1"
                   max="7" />
            <button type="submit"
                    class="btn-fitrank btn-secondary"
                    [disabled]="form.get('cantidadDias')?.invalid">
              Generar sesiones
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- üü£ CONTENIDO PRINCIPAL -->
  <div class="contenido" *ngIf="mostrarSesiones">
    <!-- LISTADO DE SESIONES Y SERIES -->
    <div class="main-panel">
      <!-- Tabs -->
      <div class="dias-tabs mb-4">
        <button *ngFor="let sesion of sesiones.controls; let i = index"
                (click)="seleccionarSesion(i)"
                class="btn-secondary"
                [ngClass]="{ active: sesionActiva === i }">
          D√≠a {{ i + 1 }}
        </button>
      </div>

      <!-- Contenido del d√≠a -->
      <div class="dia-content">
        <form [formGroup]="form" (ngSubmit)="guardarSesionActual()">
          <div formArrayName="sesiones">
            <div *ngIf="sesiones.at(sesionActiva)"
                 [formGroupName]="sesionActiva"
                 class="bloques-container btn-secondary">

                 <div class="mb-3">
                          <label for="nombreSesion">Nombre de la sesi√≥n</label>
                          <input type="text"
                                 id="nombreSesion"
                                 class="form-control"
                                 [formControl]="nombreSesionControl" />
                  </div>

              <!-- LISTA DE EJERCICIOS -->
              <div formArrayName="ejercicios" class="ejercicios-dropzone">
                <div *ngIf="getEjercicios(sesionActiva).length === 0"
                     class="alert alert-light text-center text-muted py-5 border rounded-3 shadow-sm">
                  <p class="mt-3 fw-bold text-uppercase text-secondary">
                    Tu d√≠a todav√≠a est√° vac√≠o
                  </p>
                  <p class="text-muted">Eleg√≠ ejercicios del panel derecho para empezar</p>
                </div>

                <div *ngFor="let ejercicio of getEjercicios(sesionActiva).controls; let j = index; trackBy: trackByIndex"
                     [formGroupName]="j"
                     class="bloque btn-secondary">

                  <div class="bloque-header">
                    <div class="d-flex align-items-center gap-2">
                      <!-- MINI VIDEO YOUTUBE -->
                      <ng-container *ngIf="esYoutube(ejercicio.get('urlImagen')?.value); else imagenNormal">
                        <div class="video-mini">
                          <iframe [src]="sanitizer.bypassSecurityTrustResourceUrl(convertirAEmbed(ejercicio.get('urlImagen')?.value))"
                                  frameborder="0"
                                  allowfullscreen>
                          </iframe>
                        </div>
                      </ng-container>

                      <!-- SI ES IMAGEN NORMAL -->
                      <ng-template #imagenNormal>
                        <img [src]="ejercicio.get('urlImagen')?.value"
                             class="bloque-img"
                             alt="Ejercicio">
                      </ng-template>
                      >



                      <div>
                        <h5 class="mb-0">{{ ejercicio.get('nombre')?.value }}</h5>

                        <small class="text-muted">Series: {{ getSeries(sesionActiva, j).length }}</small>
                        <small class="text-muted d-block">
                          ‚è± {{ ejercicio.get('duracionEstimada')?.value }} min
                        </small>
                      </div>
                    </div>

                    <button type="button"
                            class="btn btn-sm btn-outline-danger btn-secondary"
                            (click)="eliminarEjercicio(sesionActiva, j)">
                      üóë
                    </button>
                  </div>


                  <!-- SERIES -->
                  <div class="bloque-body" formArrayName="series">
                    <div *ngFor="let serie of getSeries(sesionActiva, j).controls; let k = index; trackBy: trackByIndex"
                         [formGroupName]="k"
                         class="serie-row">
                      <div class="serie-input">
                        <label>Peso</label>
                        <input type="number" class="form-control" formControlName="peso" />
                      </div>
                      <div class="serie-input">
                        <label>Reps</label>
                        <input type="number" class="form-control" formControlName="repeticiones" />
                      </div>
                      <div class="serie-input">
                        <label>Tiempo</label>
                        <input type="number" class="form-control" formControlName="duracion" />
                      </div>
                      <button type="button"
                              class="btn btn-outline-danger btn-sm btn-secondary"
                              (click)="eliminarSerie(sesionActiva, j, k)">
                        Quitar
                      </button>
                    </div>

                    <button type="button"
                            class="btn btn-outline-primary btn-sm mt-2 btn-secondary"
                            (click)="agregarSerie(sesionActiva, j)">
                      Agregar serie
                    </button>
                  </div>
                </div>
              </div>

              <div class="text-end mt-4">
                <button type="submit" class="btn btn-outline-primary btn-sm mt-2 btn-secondary">
                  Guardar D√≠a {{ sesionActiva + 1 }}
                </button>
                <div class="text-end mt-3 fw-bold text-secondary">
                  Duraci√≥n total del d√≠a:
                  <span class="text-dark">{{ getDuracionTotalSesion(sesionActiva) }} min</span>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- TOTAL -->
      <div class="text-center mt-4">
        <h5 class="fw-bold text-dark">
          Duraci√≥n total estimada de la rutina:
          <span class="text-fitrank">{{ getDuracionTotalRutina() }} min</span>
        </h5>
      </div>

      <!-- GUARDAR -->
      <div class="text-center mt-5">
        <button type="button" class="btn btn-outline-primary btn-sm mt-2 btn-secondary" (click)="guardarTodo()">
          Guardar Rutina
        </button>
      </div>
    </div>

    <!-- üü£ SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-content">
        <h5 class="fw-bold mb-3 text-white">Haz click para agregar tus ejercicios</h5>

        <!-- Input de b√∫squeda -->
        <input type="text"
               class="form-control mb-3"
               placeholder="Buscar Ejercicios..."
               [(ngModel)]="filtro"
               (input)="filtrarEjercicios()" />

        <!-- Botones de grupos musculares -->
        <div class="grupo-muscular-list mb-3">
          <!-- Bot√≥n "Todos" -->
          <button class="btn btn-outline-primary btn-sm me-2 mb-2"
                  (click)="recargarEjercicios()">
            Todos
          </button>

          <!-- Botones de cada grupo muscular -->
          <button *ngFor="let g of gruposMusculares"
                  class="btn btn-outline-secondary btn-sm me-2 mb-2"
                  [class.active]="grupoSeleccionadoId === g.id"
                  (click)="filtrarPorGrupo(g.id)">
            {{ g.nombre }}
          </button>
        </div>


        <!-- Listado de ejercicios filtrados -->
        <div class="ejercicio-list">
          <div *ngFor="let e of ejerciciosFiltrados"
               class="ejercicio-item"
               (click)="agregarEjercicio(e)">

            <!-- IMAGEN DEL EJERCICIO -->
            <img *ngIf="e.urlImagen"
                 [src]="e.urlImagen"
                 alt="{{ e.nombre }}"
                 class="ej-img-thumb">

            <!-- TEXTO -->
            <div class="ej-texto">
              <h6>{{ e.nombre }}</h6>
              <small>{{ e.nombreGrupoMuscular }}</small>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div> <!-- cierre de "contenido" -->


