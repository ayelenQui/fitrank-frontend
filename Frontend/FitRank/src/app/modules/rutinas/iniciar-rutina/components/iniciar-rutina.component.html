<app-header-socio></app-header-socio>

<!-- üîô Bot√≥n Volver -->
<button type="button" class="btn-volver" (click)="volverAtras()">
  ‚Üê Volver
</button>

<div class="container py-4 iniciar-rutina">

  <!-- üèãÔ∏è Rutina actual -->
  <div *ngIf="ejercicioActivo" class="row g-4">
    <!-- PANEL IZQUIERDO -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 rounded-4 p-4 panel-izquierdo">
        <h5 class="fw-bold text-center mb-3 text-fitrank">Rutina actual</h5>
        <p class="text-center text-muted mb-4">
          {{ ejercicioActivo.ejercicio?.nombre || ('Ejercicio #' + ejercicioActivo.ejercicioId) }}<br />
          Sesi√≥n {{ ejercicioActivo.sesion }} | Orden {{ ejercicioActivo.orden }}
        </p>

        <div class="timer-container text-center my-3">
          <div class="progress-ring">
            <svg class="progress-ring__svg" width="120" height="120">
              <circle class="progress-ring__background"
                      cx="60"
                      cy="60"
                      r="54" />
              <circle class="progress-ring__circle"
                      id="timerCircle"
                      cx="60"
                      cy="60"
                      r="54" />
            </svg>
            <div class="timer-text">
              <span *ngIf="!showCountdown">{{ tiempoRestante }}s</span>
              <span *ngIf="showCountdown">{{ countdownNumber }}</span>
            </div>
          </div>
        </div>

        <!-- Botones de control -->
        <div class="d-grid gap-2">
          <button class="btn btn-fitrank" [disabled]="enEjecucion" (click)="iniciarSerie()">
            ‚ñ∂ Iniciar Serie
          </button>
          <button class="btn btn-outline-fitrank" [disabled]="enEjecucion" (click)="siguienteSerie()">
            ‚û° Siguiente Serie
          </button>
          <button class="btn btn-outline-secondary" (click)="volver()">
            ‚Üê Volver
          </button>
          <button class="btn btn-outline-success" (click)="finalizarRutina()">
            üèÅ Finalizar Rutina
          </button>
          <button class="btn btn-danger" [disabled]="!enEjecucion" (click)="finalizarSerie()">
            ‚èπ Finalizar Serie
          </button>
        </div>
      </div>
    </div>

    <!-- PANEL DERECHO -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 rounded-4 p-4 panel-derecho">

        <!-- Imagen y t√≠tulo del ejercicio -->
        <div class="ejercicio-hero rounded-4 shadow-sm mb-3 overflow-hidden">
          <img [src]="getImagenEjercicio(ejercicioActivo.ejercicio?.nombre)"
               alt="Imagen del ejercicio"
               class="hero-img" />

          <div class="hero-overlay">
            <h5 class="mb-1 fw-bold">
              {{ ejercicioActivo.ejercicio?.nombre || ('Ejercicio #' + ejercicioActivo.ejercicioId) }}
            </h5>
            <p class="m-0 small">Sesi√≥n {{ ejercicioActivo.sesion }} ¬∑ Orden {{ ejercicioActivo.orden }}</p>
          </div>
        </div>

        <!-- Series -->
        <div *ngIf="seriesActuales.length > 0">
          <h6 class=" text-fitrank ">Series asignadas</h6>

          <div *ngFor="let s of seriesActuales; let i = index"
               class="serie-card-ui p-3 rounded-4 mb-3"
               [class.activa]="i === serieActivaIndex">
            <div class="serie-bar d-flex justify-content-between align-items-center mb-2">
              <strong>Serie {{ s.nroSerie || (i + 1) }}</strong>

              <div class="acciones-serie d-flex gap-2">
                <button type="button"
                        class="btn btn-fitrank-light btn-sm"
                        [disabled]="enEjecucion"
                        (click)="startCountdown(i)">
                  ‚ú® Iniciar
                </button>

                <button type="button"
                        class="btn btn-danger btn-sm"
                        [disabled]="!(enEjecucion && i === serieActivaIndex)"
                        (click)="finalizarSerie()">
                  ‚èπ Detener
                </button>
              </div>
            </div>

            <div class="row g-2">
              <div class="col-4">
                <label class="form-label small">Peso (kg)</label>
                <input type="number"
                       class="form-control form-control-sm"
                       [(ngModel)]="s.peso"
                       [readonly]="!puedeEditar || i !== serieActivaIndex" />
              </div>
              <div class="col-4">
                <label class="form-label small">Reps</label>
                <input type="number"
                       class="form-control form-control-sm"
                       [(ngModel)]="s.repeticiones"
                       [readonly]="!puedeEditar || i !== serieActivaIndex" />
              </div>
              <div class="col-4">
                <label class="form-label small">RIR</label>
                <input type="number"
                       class="form-control form-control-sm"
                       [(ngModel)]="s.rir"
                       [readonly]="!puedeEditar || i !== serieActivaIndex" />
              </div>
            </div>

            <div *ngIf="enEjecucion && i === serieActivaIndex" class="text-end mt-2">
              <span class="badge bg-fitrank-subtle text-fitrank">‚ú® En curso‚Ä¶</span>

            </div>
            <!-- Barra de progreso visual (solo visible cuando la serie est√° en ejecuci√≥n) -->
            <div *ngIf="enEjecucion && i === serieActivaIndex" class="progress-container mt-3">
              <div class="progress-bar" id="progressBar{{i}}"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LISTADO DE EJERCICIOS (si a√∫n no seleccion√≥ ninguno) -->
  <div *ngIf="!ejercicioActivo" class="listado-ejercicios container py-4">
    <h3 class="text-center titulo-fitrank">
      ‚ú® Iniciar Rutina
    </h3>

    <div *ngFor="let e of ejerciciosAsignados" class="card ejercicio-card shadow-sm mb-4">
      <div class="card-body d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
        <div class="text-start titulo-fitrank">
          <h5 class="fw-semibold text-dark mb-1">
            {{ e.ejercicio?.nombre || ('Ejercicio #' + e.ejercicioId) }}
          </h5>
          <p class="text-muted small mb-0">
            <span class="me-2"><strong>Orden:</strong> {{ e.orden }}</span> |
            <span class="ms-2"><strong>Sesi√≥n:</strong> {{ e.sesion }}</span>
          </p>
        </div>

        <button class="btn btn-fitrank px-4 py-2 mt-3 mt-md-0" (click)="seleccionarEjercicio(e)">
          <span class="material-symbols-outlined align-middle me-1">play_arrow</span>
          ‚ú® Iniciar ejercicio
        </button>
      </div>
    </div>
  </div>


  <!-- Overlay cuenta regresiva GSAP -->
  <div class="countdown-overlay" *ngIf="showCountdown">
    <div id="countdownCircle">{{ countdownNumber }}</div>
  </div>
